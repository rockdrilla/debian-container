#!/bin/sh
# SPDX-License-Identifier: Apache-2.0
# (c) 2023, Konstantin Demin

set -f

src_file='/etc/apt/sources.list.d/backports.list'

me="${0##*/}"
usage() {
	cat >&2 <<-EOF
	# usage:
	#   apt source file:  ${me} {enable|disable|status}
	#   apt pin file:     ${me} {enable-pin|disable-pin|pin-status}
	#   all-in-one:       ${me} {enable-all|disable-all}
	EOF
	exit "${1:-0}"
}
[ $# != 0 ] || usage

status() {
	status=$( [ -s "${src_file}" ] && echo enabled || echo disabled)
	echo "# ${0##*/}: ${status}" >&2
	[ -s "${src_file}" ]
}

VERSION_CODENAME=$(sed -En '/^VERSION_CODENAME=(.+)$/s//\1/p' /etc/os-release)
: "${VERSION_CODENAME:?}"

xsedx=$(printf '\027')
chanlist='(main|contrib|non-free|restricted|universe|multiverse)'
sed_sources="\\${xsedx}^\\s*(deb\\s.+\\S)\\s+(${VERSION_CODENAME})\\s+(${chanlist}(|\\s.*\\S))\\s*\$${xsedx}{s//\\1 \\2-backports \\3/p}"

rolling=
if [ "$(sed -En "${sed_sources}" < /etc/apt/sources.list | wc -l)" = 0 ] ; then
	rolling=1
fi

if [ -n "${rolling}" ] ; then
	echo "# ${0##*/}: irrelevant for rolling release channels" >&2
	exit 0
fi

act=$(echo "$1" | tr '[:upper:]' '[:lower:]')
case "${act}" in
status)
	status
	exit
;;
pin-status)
	apt-pin backports status
	exit
;;
# internal
get-path)
	echo "${src_file}"
	exit 0
;;
# internal
get-pin-path)
	apt-pin backports get-path
	exit
;;
enable|enable-pin|enable-all) ;;
disable|disable-pin|disable-all) ;;
*)
	env printf "# ${0##*/}: unknown action: %q\\n" "$1" >&2
	exit 1
;;
esac

case "${act}" in
enable|enable-all)
	sed -En "${sed_sources}" < /etc/apt/sources.list > "${src_file}" || exit
;;
disable|disable-all)
	rm -v "${src_file}" || :
;;
esac

case "${act}" in
enable-pin|enable-all)
	apt-pin backports 500 '@{suite}-backports' '*'
;;
disable-pin|disable-all)
	apt-pin backports rm
;;
esac
