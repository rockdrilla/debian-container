#!/usr/bin/make -f

SHELL       :=/bin/sh
.SHELLFLAGS :=-ec

PYTHON_VERSION ?= 3.11.1
PYTHON_PIP_VERSION ?= 22.3.1
PYTHON_SETUPTOOLS_VERSION ?= 65.5.1

empty :=
space :=$(empty) $(empty)
comma :=,
xsedx :=$(shell printf '\027')

PYTHON_MAJOR_VERSION = $(word 1,$(subst .,$(space),$(PYTHON_VERSION)))
PYTHON_MINOR_VERSION = $(word 2,$(subst .,$(space),$(PYTHON_VERSION)))
PYTHON_PATCH_VERSION = $(word 3,$(subst .,$(space),$(PYTHON_VERSION)))

PYTHON_BASE_VERSION = $(PYTHON_MAJOR_VERSION).$(PYTHON_MINOR_VERSION)

DEB_PYTHON_PRIO = $(shell printf '%d%03d0' $(PYTHON_MAJOR_VERSION) $(PYTHON_MINOR_VERSION))

include debian/rules.pkg-info

MAKEFLAGS += --no-print-directory

export DH_VERBOSE := 1

include /usr/share/dpkg/default.mk

# handles DATE and TIME in Modules/getbuildinfo.c
export SOURCE_DATE_EPOCH

ifneq ($(DEB_HOST_ARCH_OS),linux)
  $(warning unhandled operating system name: $(DEB_HOST_ARCH_OS))
endif

distribution = $(if $(filter Ubuntu,$(DEB_VENDOR) $(DEB_PARENT_VENDOR)),Ubuntu,Debian)
distrelease  = $(shell sed -En '/^VERSION_CODENAME=(.+)$$/s//\1/p' /etc/os-release)

with_dtrace := no

# applies only to Python 3.9+
with_pgo_full := $(if $(filter pgo_full,$(DEB_BUILD_OPTIONS)),yes,no)

arch_pgo := amd64 armel armhf arm64 i386 powerpc ppc64 ppc64el s390x
with_pgo := $(if $(findstring $(DEB_HOST_ARCH),$(arch_pgo)),yes)
with_pgo := $(if $(filter nopgo,$(DEB_BUILD_OPTIONS)),no,$(with_pgo))

arch_lto := amd64 armel armhf arm64 i386 powerpc ppc64 ppc64el s390x
with_lto := $(if $(findstring $(DEB_HOST_ARCH),$(arch_lto)),yes)
with_lto := $(if $(filter nolto,$(DEB_BUILD_OPTIONS)),no,$(with_lto))

ifeq ($(distribution),Ubuntu)
  # test_ssl assumes that openssl is compiled with security level set to 1
  # make it so, during the build
  export OPENSSL_CONF = $(CURDIR)/debian/tests/openssl.cnf
endif

# try to build with fresh gcc available
gcc_version_suffix = -$(strip $(shell apt-cache search '^gcc-[0-9.]+' | mawk '/^gcc-[0-9.]+ /{print $$1}' | sort -rV | head -n 1 | cut -d - -f 2))

CC     = $(DEB_HOST_GNU_TYPE)-gcc$(gcc_version_suffix)
CXX    = $(DEB_HOST_GNU_TYPE)-g++$(gcc_version_suffix)
AR     = $(DEB_HOST_GNU_TYPE)-gcc-ar$(gcc_version_suffix)
RANLIB = $(DEB_HOST_GNU_TYPE)-gcc-ranlib$(gcc_version_suffix)
export CC CXX AR RANLIB

DEB_BUILD_MAINT_OPTIMIZE = optimize=-lto

dpkg_buildflags = env \
  DEB_BUILD_MAINT_OPTIONS='hardening=+all,-stackprotectorstrong $(DEB_BUILD_MAINT_OPTIMIZE)' \
  dpkg-buildflags

# default is -O3
CFLAGS   = $(filter-out -O%,$(shell $(dpkg_buildflags) --get CFLAGS))
# default is -O3
CXXFLAGS = $(filter-out -O%,$(shell $(dpkg_buildflags) --get CXXFLAGS))
CPPFLAGS = $(shell $(dpkg_buildflags) --get CPPFLAGS)
LDFLAGS  = $(shell $(dpkg_buildflags) --get LDFLAGS)

ifeq ($(with_lto),yes)
  LTO_FLAGS = -O3 -g -fwrapv -flto=auto -ffat-lto-objects -fuse-linker-plugin

  ifneq (,$(filter lto_part=%,$(DEB_BUILD_OPTIONS)))
    LTO_FLAGS += -flto-partition=$(strip $(lastword $(patsubst lto_part=%,%,$(filter lto_part=%,$(DEB_BUILD_OPTIONS)))))
  endif

  CFLAGS   += $(LTO_FLAGS)
  CXXFLAGS += $(LTO_FLAGS)
  LDFLAGS  += $(LTO_FLAGS)
endif

export CFLAGS CPPFLAGS CXXFLAGS LDFLAGS

config_site = \
	ac_cv_file__dev_ptmx=yes \
	ac_cv_file__dev_ptc=yes \
	ac_cv_posix_semaphores_enabled=yes \


libmpdec_ver := $(shell dpkg-query --show --showformat='$${Version}' libmpdec-dev 2>/dev/null || echo 0)
ifneq ($(libmpdec_ver),0)
  ifeq (0,$(shell dpkg --compare-versions $(libmpdec_ver) gt 2.5 ; echo $$?))
    libmpdec_conf = --with-system-libmpdec
  endif
endif

dtrace_build_dep =
ifeq ($(with_dtrace),yes)
dtrace_build_dep = systemtap-sdt-dev$(comma)
dtrace_conf = --with-dtrace
endif

# NB: "XX" in the beginning of list is MANDATORY
builtin_ext = XX \
 _abc _ast _bisect _blake2 _collections _csv _datetime _elementtree \
 _functools _heapq _locale _md5 _opcode _operator _pickle \
 _posixsubprocess _random _sha1 _sha3 _sha256 _sha512 _socket _stat \
 _stringio _struct _tracemalloc array atexit binascii cmath fcntl grp \
 itertools math pyexpat select spwd syslog time unicodedata zlib

builtin_ext__list =$(strip $(foreach ext,$(builtin_ext),$(ext)$(space)))
builtin_ext__re   =$(subst $(space),|,$(builtin_ext__list))

build_dir = $(CURDIR)/debian.build

# TEST_OPTS and TEST_EXCLUDES are defined here
include debian/rules.tests

# PROFILE_OPTS and PROFILE_EXCLUDES are defined here
include debian/rules.profile

ifneq (,$(wildcard debian/rules.local))
include debian/rules.local
endif

.NOTPARALLEL:

DH_ARGS = --buildsystem=autoconf

%:
	dh $@ $(DH_ARGS)

DH_ARGS_shared = $(DH_ARGS) --sourcedir=$(CURDIR) --builddir=$(build_dir)

override_dh_autoreconf:
	dh_autoreconf autoreconf -- -fiv -Werror

execute_before_dh_auto_configure:
	: # verify that we' having "right" gcc version
	@echo '# CC = $(CC)' >&2
	@$(CC) --version 2>&1 | head -n 1 >&2

	: # verify CFLAGS
	@echo "# CFLAGS = $${CFLAGS}" >&2

	: # verify DEB_BUILD_OPTIONS
	@echo "# DEB_BUILD_OPTIONS = $${DEB_BUILD_OPTIONS}" >&2

override_dh_auto_configure:
	OPT= \
	$(config_site) \
	dh_auto_configure $(DH_ARGS_shared) -- \
	  --enable-shared \
	  --enable-ipv6 \
	  --with-computed-gotos $(if $(filter yes,$(with_pgo)),--enable-optimizations) \
	  --with-system-expat \
	  --with-system-ffi $(libmpdec_conf) $(dtrace_conf) \
	  --enable-loadable-sqlite-extensions \
	  --with-dbmliborder=bdb:gdbm \
	  --without-ensurepip \
	  MKDIR_P="/bin/mkdir -p"

execute_after_dh_auto_configure:
	sed -En '/^#($(builtin_ext__re))/p' Modules/Setup \
	| sed -E 's/^#//;s/-Wl,-Bdynamic//;s/-Wl,-Bstatic//' \
	>> $(build_dir)/Modules/Setup.local

	: # unconditionally run makesetup
	cd $(build_dir) && \
	$(CURDIR)/Modules/makesetup \
	  -c $(CURDIR)/Modules/config.c.in \
	  -s Modules \
	  Modules/Setup.local $(CURDIR)/Modules/Setup
	mv $(build_dir)/config.c $(build_dir)/Modules/

	: # and fix the timestamps
	$(MAKE) -C $(build_dir) Makefile Modules/config.c

override_dh_auto_build:
	sed -i -E \
		$(if $(filter yes,$(with_pgo_full)),-e '/^PROFILE_TASK[[:space:]]*=/s/--pgo/--pgo-extended/') \
		-e '/^PROFILE_TASK[[:space:]]*=/s$(xsedx)$$$(xsedx) $(PROFILE_OPTS)$(xsedx)' \
	$(build_dir)/Makefile
	dh_auto_build $(DH_ARGS_shared)

ifeq (,$(filter nocheck,$(DEB_BUILD_OPTIONS)))

test_LD_LIBRARY_PATH = $(build_dir)$(if $(LD_LIBRARY_PATH),:$(LD_LIBRARY_PATH))
test_python_bin = $(build_dir)/python

test_python = LD_LIBRARY_PATH='$(test_LD_LIBRARY_PATH)' \
	PYTHONDONTWRITEBYTECODE=1 \
	PYTHONUNBUFFERED=1 \
	SSL_CERT_FILE=/etc/ssl/certs/ca-certificates.crt \
	REQUESTS_CA_BUNDLE=/etc/ssl/certs/ca-certificates.crt \
	fakeroot $(test_python_bin)

execute_before_dh_auto_test:
	: # check that things are correctly built
ifneq (,$(filter $(DEB_HOST_ARCH_OS),linux))
	$(test_python) -c 'from _multiprocessing import SemLock'
endif
	$(test_python) -c 'import _decimal'
	$(test_python) -c 'import math, cmath'

override_dh_auto_test:
	dh_auto_test $(DH_ARGS_shared) -- TESTOPTS="$(TEST_OPTS)"

endif

override_dh_auto_install:
	dh_auto_install $(DH_ARGS_shared)

execute_after_dh_auto_install:
	: # remove manpages
	rm -vrf debian/tmp/usr/share/man/

	: # remove python cache
	find debian/tmp/ -name __pycache__ -type d -exec rm -rf '{}' '+'
	find debian/tmp/ -name '*.py[co]' -ls -delete

	: # remove IDLE at all
	find debian/tmp/ -path '*/bin/idle*' -exec rm -vf '{}' '+'
	find debian/tmp/ -path '*/lib/python$(PYTHON_BASE_VERSION)/idlelib' -type d -exec rm -vrf '{}' '+'

	: # remove provided pip and site-packages
	find debian/tmp/ -path '*/bin/pip*' -exec rm -vf '{}' '+'
	find debian/tmp/ -path '*/lib/python$(PYTHON_BASE_VERSION)/site-packages' -type d -print0 \
	| xargs -0 -r -n 1 -I '$$d' \
		find '$$d/' -mindepth 1 -maxdepth 1 -exec rm -vrf '{}' '+'

	: # remove builtin testsuite
	find debian/tmp/ -path '*/lib/python$(PYTHON_BASE_VERSION)/*/test' -type d -exec rm -rf '{}' '+'
	find debian/tmp/ -path '*/lib/python$(PYTHON_BASE_VERSION)/*/tests' -type d -exec rm -rf '{}' '+'

	: # preserve only small part of /lib/python$(PYTHON_BASE_VERSION)/test/
	find debian/tmp/ -path '*/lib/python$(PYTHON_BASE_VERSION)/test' -type d \
	| while read -r d ; do \
		rm -f debian/test.tar ; \
		find "$$d" -regextype egrep \
		  -regex '.+/test/(libregrtest|support|(__.+|ann_module.*|regrtest|test_support)\.py)$$' \
		  -exec tar -cf debian/test.tar '{}' '+' ; \
		find "$$d/" -mindepth 1 -maxdepth 1 -exec rm -vrf '{}' '+' ; \
		tar -xf debian/test.tar ; \
		rm -f debian/test.tar ; \
	done

	: # remove non-fully versioned symlinks
	find debian/tmp/ -path '*/bin/*' -type l -exec rm -vf '{}' '+'
	find debian/tmp/ -path '*/lib/$(DEB_HOST_MULTIARCH)/pkgconfig/*' -type l -exec rm -vf '{}' '+'

	: # minor file name mangling
	cd debian/tmp/usr/bin ; mv python$(PYTHON_BASE_VERSION)-config $(DEB_HOST_MULTIARCH)-python$(PYTHON_BASE_VERSION)-config

PY_INTERPRETER =/usr/bin/python$(PYTHON_BASE_VERSION)

define fix_hashbangs_r

	hashbang_rx='#!.*[/ ]python[^ ]*' ; \
	list='$(strip $(1)).hashbang' ; \
	find '$(strip $(1))/' -type f -exec grep -EIl "$${hashbang_rx}" '{}' '+' \
	> "$${list}" || : ; \
	if [ -s "$${list}" ] ; then \
		while read -r f ; do \
			[ -n "$$f" ] || continue ; \
			x_flag=1 ; \
			[ -x "$$f" ] || x_flag= ; \
			sed -E "1s$(xsedx)$${hashbang_rx}$(xsedx)#!$(PY_INTERPRETER)$(xsedx)" \
			< "$$f" > "$${list}.tmp" ; \
			if ! cmp -s "$${list}.tmp" "$$f" ; then \
				echo "# fixed hashbang: $$f" ; \
				mv -f "$${list}.tmp" "$$f" ; \
			fi ; \
			if [ -z "$${x_flag}" ] ; then \
				echo "# fixed permissions: $$f" ; \
			fi ; \
			chmod 0755 "$$f" ; \
		done < "$${list}" >&2 ; \
		rm -f "$${list}.tmp" ; \
	fi ; \
	rm -f "$${list}"

endef

replace_string = -e "s/ $(1) / $(2) /g;s/ $(1)/ $(2)/g;s/$(1) /$(2) /g;s/$(1)/$(2)/g"
remove_string  = -e "s/ $(1) / $(2)/g;s/ $(1)/ $(2)/g;s/$(1) /$(2) /g;s/$(1)/$(2)/g"
replace_prefixed = $(call replace_string,$(1)[^[:space:]\"']*,$(2))
remove_prefixed  = $(call replace_prefixed,$(1)[^[:space:]\"']*,)

fake_srcdir =/usr/local/src/python/$(DEB_VERSION_UPSTREAM)

define buildrepro_backup

	mkdir -p $(shell printf '%s' '$(dir $(strip $(1)))' | sed -zE 's,^debian/[^/]+/,debian/dist.orig/,')

	cp $(strip $(1)) $(shell printf '%s' '$(strip $(1))' | sed -zE 's,^debian/[^/]+/,debian/dist.orig/,')

endef

# TODO: re-sync periodically with "sysconfig_substflags" in Debian
define buildrepro_fix

	sed -i \
		-e 's|$(CC)|$(DEB_HOST_GNU_TYPE)-gcc|g' \
		-e 's|$(CC)|$(DEB_HOST_GNU_TYPE)-gcc|g' \
		-e 's|$(CXX)|$(DEB_HOST_GNU_TYPE)-g++|g' \
		-e 's|$(AR)|$(DEB_HOST_GNU_TYPE)-gcc-ar|g' \
		-e 's|$(RANLIB)|$(DEB_HOST_GNU_TYPE)-gcc-ranlib|g' \
	$(strip $(1))

	sed -i -E \
		$(call remove_prefixed,LD_LIBRARY_PATH=) \
		$(call remove_prefixed,-f(debug|file|macro|profile)-prefix-map=) \
		$(call remove_prefixed,-flto) \
		$(call remove_string,-ffat-lto-objects) \
		$(call remove_string,-fuse-linker-plugin) \
		$(call remove_prefixed,-fprofile) \
		$(call replace_prefixed,-fstack-protector,-fstack-protector-strong) \
		$(call replace_string,-fstack-protector-strong-strong,-fstack-protector-strong) \
		$(call remove_prefixed,--param=ssp-buffer-size=) \
		$(call remove_prefixed,-specs=) \
		$(call remove_string,-Wl$(comma)-z$(comma)now) \
		$(call remove_string,-L\.) \
		$(call replace_string,-O3,-O2) \
		$(call replace_string,-Wl$(comma)-z$(comma)relro +-Wl$(comma)-z$(comma)relro,-Wl$(comma)-z$(comma)relro) \
		-e 's/^RUNSHARED\s*=.*$$/RUNSHARED=/g' \
	$(strip $(1))

 	sed -i \
 		-e 's|$(build_dir)/..|$(fake_srcdir)|g' \
 		-e 's|$(CURDIR)|$(fake_srcdir)|g' \
 	$(strip $(1))

endef

define buildrepro_compare

	mkdir -p $(shell printf '%s' '$(dir $(strip $(1)))' | sed -zE 's,^debian/[^/]+/,debian/dist/,')

	cp $(strip $(1)) $(shell printf '%s' '$(strip $(1))' | sed -zE 's,^debian/[^/]+/,debian/dist/,')

	set +e ; diff -Naru --color \
	$(shell printf '%s' '$(strip $(1))' | sed -zE 's,^debian/[^/]+/,debian/dist.orig/,') \
	$(shell printf '%s' '$(strip $(1))' | sed -zE 's,^debian/[^/]+/,debian/dist/,') \
	|| :

endef

# "aio" stands for "all-in-one"
define buildrepro_aio

	$(call buildrepro_backup,$(strip $(1)))

	$(call buildrepro_fix,$(strip $(1)))

	$(call buildrepro_compare,$(strip $(1)))

endef

PIP_CONF = $(word 1,$(wildcard debian/pip.conf.local) debian/pip.conf)

limb_PYTHONHOME = $(CURDIR)/debian/tmp/usr
limb_LD_LIBRARY_PATH = $(limb_PYTHONHOME)/lib/$(DEB_HOST_MULTIARCH)$(if $(LD_LIBRARY_PATH),:$(LD_LIBRARY_PATH))
limb_python_bin = $(limb_PYTHONHOME)/bin/python$(PYTHON_BASE_VERSION)

limb_python = LD_LIBRARY_PATH='$(limb_LD_LIBRARY_PATH)' \
	PYTHONHOME='$(limb_PYTHONHOME)' \
	PYTHONDONTWRITEBYTECODE=1 \
	PYTHONUNBUFFERED=1 \
	SSL_CERT_FILE=/etc/ssl/certs/ca-certificates.crt \
	REQUESTS_CA_BUNDLE=/etc/ssl/certs/ca-certificates.crt \
	PIP_CONFIG_FILE='$(CURDIR)/$(PIP_CONF)' \
	fakeroot $(limb_python_bin)

execute_before_dh_install:
	mkdir -p debian/tmp/usr/share/python$(PYTHON_BASE_VERSION)
	cp $(PIP_CONF) debian/tmp/usr/share/python$(PYTHON_BASE_VERSION)/pip.conf

	$(call fix_hashbangs_r, debian/tmp )

	$(call buildrepro_aio, debian/tmp/usr/bin/$(DEB_HOST_MULTIARCH)-python$(PYTHON_BASE_VERSION)-config )
	$(call buildrepro_aio, debian/tmp/usr/lib/python$(PYTHON_BASE_VERSION)/config-$(PYTHON_BASE_VERSION)-$(DEB_HOST_MULTIARCH)/config.c )
	$(call buildrepro_aio, debian/tmp/usr/lib/python$(PYTHON_BASE_VERSION)/config-$(PYTHON_BASE_VERSION)-$(DEB_HOST_MULTIARCH)/Makefile )

	$(call buildrepro_backup, debian/tmp/usr/lib/python$(PYTHON_BASE_VERSION)/_sysconfigdata__$(DEB_HOST_MULTIARCH).py )

	: # adjust sysconfigdata
	cat \
		debian/regen-sysconfigdata.py.pre \
		debian/tmp/usr/lib/python$(PYTHON_BASE_VERSION)/_sysconfigdata__$(DEB_HOST_MULTIARCH).py \
		debian/regen-sysconfigdata.py.post \
	> debian/tmp/regen-sysconfigdata.py
	$(limb_python) debian/tmp/regen-sysconfigdata.py \
	  debian/tmp/usr/lib/python$(PYTHON_BASE_VERSION)/_sysconfigdata__$(DEB_HOST_MULTIARCH).py
	rm -f debian/tmp/regen-sysconfigdata.py

	$(call buildrepro_fix, debian/tmp/usr/lib/python$(PYTHON_BASE_VERSION)/_sysconfigdata__$(DEB_HOST_MULTIARCH).py )
	sed -i -E \
		-e 's/  +/ /g' \
	debian/tmp/usr/lib/python$(PYTHON_BASE_VERSION)/_sysconfigdata__$(DEB_HOST_MULTIARCH).py
	$(call buildrepro_compare, debian/tmp/usr/lib/python$(PYTHON_BASE_VERSION)/_sysconfigdata__$(DEB_HOST_MULTIARCH).py )

define dh_dedup

	: # remove duplicate files from shared directory
	find debian/$(strip $(1)) -type f | sort -V > debian/$(strip $(1)).dedup
	while read -r s ; do \
		[ -n "$$s" ] || continue ; \
		d=$$(printf '%s' "$$s" | sed -zE 's,^debian/$(strip $(1)),debian/tmp,') ; \
		if cmp -s "$$s" "$$d" ; then \
			rm -f "$$d" ; \
		else \
			echo "# CHANGED: $$s" >> debian/$(strip $(1)).dedup.changed ; \
		fi ; \
	done < debian/$(strip $(1)).dedup
	rm -f debian/$(strip $(1)).dedup
	if [ -s debian/$(strip $(1)).dedup.changed ] ; then \
		echo ; \
		cat debian/$(strip $(1)).dedup.changed ; \
		echo ; \
		exit 1 ; \
	fi >&2
	rm -f debian/$(strip $(1)).dedup.changed

	: # remove symlinks from shared directory
	find debian/$(strip $(1)) -type l -print0 \
	| sed -zE 's,^debian/$(strip $(1)),debian/tmp,' \
	| xargs -0 -r rm -fv

	: # remove empty directories (without files/symlinks)
	find debian/$(strip $(1)) -mindepth 1 -type d -print0 \
	| sed -zE 's,^debian/$(strip $(1)),debian/tmp,' \
	| sort -zV | xargs -0 -r -n 1 \
	| while read -r d ; do \
		[ -d "$$d" ] || continue ; \
		find "$$d" ! -type d -printf . -quit | grep -Fq . || rm -rf "$$d" ; \
	done

endef

define dh_install_move

	: # install package files as usual
	dh_install -p$(strip $(1))
	$(call dh_dedup,$(strip $(1)))

endef

override_dh_install:
	$(call dh_install_move, container-python-misc-$(PYTHON_BASE_VERSION) )

	: # remove wheels
	find debian/tmp/ -iname '*.whl' -ls -delete

	: # remove non-native platform files
	find debian/tmp/ -iname '*.exe' -ls -delete

	$(call dh_install_move, container-python-dev-$(PYTHON_BASE_VERSION) )

	: # precompile Python (subject to change)
	: # DISABLED $(limb_python) -m compileall debian/tmp/usr/lib/python$(PYTHON_BASE_VERSION)

	: # we're have "clean" Python at this point, but we need to get pip working,
	: # so using standard "dh_install" instead of our "dh_install_move"
	dh_install -pcontainer-python-$(PYTHON_BASE_VERSION)

	: # install pip and setuptools via preseeded debian/get-pip.py
	$(limb_python) debian/get-pip.py \
	  --disable-pip-version-check --no-cache-dir --no-warn-script-location --no-compile \
	  'pip==$(PYTHON_PIP_VERSION)' \
	  'setuptools==$(PYTHON_SETUPTOOLS_VERSION)' \
	;

	: # list installed packages
	$(limb_python) $(limb_PYTHONHOME)/bin/pip \
	  --disable-pip-version-check --no-cache-dir \
	  list --format json \
	> debian/tmp/pip.json

	: # upgrade installed packages
	$(limb_python) $(limb_PYTHONHOME)/bin/pip \
	  --disable-pip-version-check --no-cache-dir \
	  install --upgrade \
	  $$(jq -r '.[].name' < debian/tmp/pip.json)

	: # list installed packages (refreshing version info)
	$(limb_python) $(limb_PYTHONHOME)/bin/pip \
	  --disable-pip-version-check --no-cache-dir \
	  list --format json \
	> debian/tmp/pip.json

	: # produce list of individual installed packages
	jq -r '.[] | "pip:version:" + .name + "=" + .version' \
	< debian/tmp/pip.json \
	>> debian/pip.substvars

	: # produce "auto" list of installed packages
	jq -r '.[] | "python$(PYTHON_MAJOR_VERSION)-" + .name + " (=" + .version + ")"' \
	< debian/tmp/pip.json \
	| paste -sd',' | sed -E 's/^/pip:autolist=/' \
	>> debian/pip.substvars

	rm -f debian/tmp/pip.json

	: # remove python cache (again)
	find debian/tmp/ -name __pycache__ -type d -exec rm -rf '{}' '+'
	find debian/tmp/ -name '*.py[co]' -ls -delete

	: # remove wheels
	find debian/tmp/ -name '*.whl' -ls -delete

	: # remove non-native platform files
	find debian/tmp/ -iname '*.exe' -ls -delete

	: # remove already installed files from container-python-$(PYTHON_BASE_VERSION)
	$(call dh_dedup, container-python-$(PYTHON_BASE_VERSION) )

	: # minor file name mangling and cleanup
	cd debian/tmp/usr/bin ; \
	mv wheel wheel$(PYTHON_BASE_VERSION) ; \
	rm -f pip pip3

	: # install remaining packages
	$(call dh_install_move, container-python-full-$(PYTHON_BASE_VERSION) )

# if there're files left - dh_missing will do the job (raise error)

# fix hashbangs in scripts and change permissions on them
execute_after_dh_install:
	$(foreach p, $(shell dh_listpackages), $(call fix_hashbangs_r, debian/$(p)) )

# sync with execute_before_dh_install
execute_before_dh_builddeb:
	set +e ; \
	find $(foreach p, $(shell dh_listpackages), debian/$(p)/ ) -type f \
	  -exec grep -aFl -e '$(CURDIR)' '{}' '+' \
	| sort -V > debian/build.reproducible ; \
	if [ -s debian/build.reproducible ] ; then \
		echo ; \
		echo '# detected build path leakage in files:' ; \
		echo ; \
		cat debian/build.reproducible ; \
		echo ; \
	fi >&2 ; \
	find $(foreach p, $(shell dh_listpackages), debian/$(p)/ ) -type f \
	  -exec grep -aEl -e '(LD_LIBRARY|LD_PRELOAD|fakeroot|eatmydata|f(debug|file|macro|profile)-prefix-map|flto|ffat-lto|fuse-linker-plugin|fprofile|param=ssp-buffer-size=4|specs=|Wl,-z,now)' '{}' '+' \
	| sort -V > debian/build.reproducible ; \
	if [ -s debian/build.reproducible ] ; then \
		echo ; \
		echo '# detected (possible) build env leakage in files:' ; \
		echo ; \
		cat debian/build.reproducible ; \
		echo ; \
	fi >&2 ; \
	rm -f debian/build.reproducible

override_dh_gencontrol:
	dh_gencontrol -- -Tdebian/pip.substvars -Tdebian/substvars

include debian/rules.selftemplate
